---
title: "Applied example with package missmeta"
author: "Irene Alfarone"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Meta-analysis of psychotherapies and depression

The goal of the present markdown is to show the use of missmeta to impute missing outcomes in bivariate meta-analysis under different missigness assumptions.

### Dataset

Cuijpers et al. (2010) conducted a meta-analysis to assess whether clinician ratings and self-reports of depression differ in estimating the efficacy of psychotherapy. They collected 48 studies with 70 psychotherapy conditions compared to a control group. For this analysis we considered a subset of 37 studies presented in the Appendix A in which outcomes were reported on the HRSD-17 and BDI and the therapy group was compared to just one control. Data for the treatment group were retrieved from Cuijpers et al. (2010); data for the control group were retrieved from the METAPSY database available at: <https://www.metapsy.org/database/depression-psychotherapy>, when not reported there, directly from the original papers. We were not able to identify post treatment data for three studies. Similarly to Cuijpers et al., since the studies presented multiple comparisons with the same control group, we report here the analysis with studies that, if presenting multiple comparisons, report the highest mean difference. In case of ties, the comparison with the highest mean difference on the BDI was retained.

```{r data, message = FALSE}
library(readxl)
library(dplyr)

d = read_xlsx("cujipersetal-data2.xlsx", sheet = "Sheet2")

d <- d %>%
  mutate(
    across(c(-Study, -Psychotherapy), as.numeric),
    MissHRSD=ifelse(is.na(`T-HRSD-M-Post`), "0", "1"),
    MissBDI=ifelse(is.na(`T-BDI-M-Post`), "0", "1"),
    across(c(Psychotherapy), as.factor)
  )

df <- d[-c(2, 4, 7, 13, 17, 19, 21, 27, 31, 34, 36, 37, 38, 45, 48, 56, 58, 59),]

df$EstSR <- df$`T-BDI-M-Post` - df$`C-BDI-M-Post`
df$EstCR <- df$`T-HRSD-M-Post` - df$`C-HRSD-M-Post`

Spooled <- function(Nt, sdt, Nc, sdc)
{
  sqrt(((Nt-1)*sdt^2 + (Nc-1)*sdc^2)/((Nt-1)+(Nc-1)))
}

BDI_sp <- Spooled(df$Nt, df$`T-BDI-SD-Post`, df$Nc, df$`C-BDI-SD-Post`)
df$SESR <- BDI_sp * sqrt((1/df$Nt)+(1/df$Nc))


HRSD_sp <- Spooled(df$Nt, df$`T-HRSD-SD-Post`, df$Nc, df$`C-HRSD-SD-Post`)
df$SECR <- HRSD_sp * sqrt((1/df$Nt)+(1/df$Nc))

dmnar = df[,c("Study", "N", "EstCR", "SECR", "EstSR", "SESR")]
dmnar$Cor.ws = 0.7
dmnar$Cor.ws[is.na(dmnar$EstCR) | is.na(dmnar$EstSR)] = NA
head(dmnar)
```

## Imputing data using function from missmeta

### Prepare the distributions

```{r distr}
library(missmeta)
library(tmvtnorm)
library(mvtnorm)

unif1 <- function(n) runif(n, min = -11, max = 11)
unif2 <- function(n) runif(n, min = -11, max = 11)

norm01 <- function(n) rnorm(n, mean = 0, sd = 6)
norm02 <- function(n) rnorm(n, mean = 0, sd = 6)

norm61 <- function(n) rnorm(n, mean = 6, sd = 6)
norm62 <- function(n) rnorm(n, mean = 6, sd = 6)

normn61 <- function(n) rnorm(n, mean = -6, sd = 6)
normn62 <- function(n) rnorm(n, mean = -6, sd = 6)

sigma = matrix(c(6^2,
                 CorCov(6,6,0.7), 
                 CorCov(6,6,0.7), 
                 6^2), nrow = 2)

lower = c(-100, -100)
upper = c(100, 100)

mtv1 = function(n) rtmvnorm(n, mean = c(-6, -6), sigma = sigma, lower = lower, upper = upper)[,1]
mtv2 = function(n) rtmvnorm(n, mean = c(-6, -6), sigma = sigma, lower = lower, upper = upper)[,2]

```

### Impute under different scenarios

```{r genimp}
imp1 <- list(unif1, norm01, norm61, normn61, mtv1)
imp2 <- list(unif2, norm02, norm62, normn62, mtv2)

out <- mapply(function(i1, i2) {
  genimp(
    df = dmnar,
    iter = 500,
    imp1 = i1,
    imp2 = i2,
    eff1 = "EstCR",
    eff2 = "EstSR",
    se1 = "SECR",
    se2 = "SESR",
    cor = "Cor.ws",
    N = "N",
    imprho = 0.6
  )
}, i1 = imp1, i2 = imp2, SIMPLIFY = FALSE)

```

### Compute meta-analysis for each imputed dataset

The user can autonomously choose the preferred meta-analysis package to conduct multivariate meta-analysis (e.g., `metaSEM`, `mixmeta`, `metafor`).

```{r makemeta}
library(mixmeta)

outls = unlist(out, recursive = FALSE)

res = lapply(outls, function(data) {
  theta = cbind(data$EstCR, data$EstSR)
  Sigma = cbind(data$SECR^2, CorCov(data$SECR, data$SESR, data$Cor.ws), data$SESR^2)
  
  m = mixmeta(theta, S = Sigma, method = "ml")
  s = summary(m)
  ci = confint(m)
  
  results = data.frame(
  eff1 = s$coefficients[1,1],
  eff2 = s$coefficients[2,1],
  se1 = s$coefficients[1, 2],
  se2 = s$coefficients[2, 2],
  cov12 = s$vcov[1, 2],
  ci.lb1 = ci[1, 1], ci.ub1 = ci[1, 2],
  ci.lb2 = ci[2, 1], ci.ub2 = ci[2, 2]
  )
  
})

res <- do.call(rbind, res)

res <- split(res,  rep(1:5, each=500))
```

## Summarize results for imputed datasets

With `makepooldata` I prepare the dataset to make it suitable for the function
`sumeth_multi` that pools the estimates and standard errors from the iterations 
using Rubin's rules.

```{r sum_meth}

pooldata <- lapply(res, function(x) {
  makepooldata(data = x, effs = "eff", ses = "se", covs = "cov")
})

methods <- c("Uniform (-11, 11)", "Normal CR = 0, SR = 0", "Normal CR = 6, SR = 6",
               "Normal CR = -6, SR = -6", "Multivariate Normal (-6, -6)")

sumres <- mapply(function(p, label) {
  sumeth_multi(Q_mat = p$Q_mat, U_list = p$U_list, method = label)
}, p = pooldata, label = methods, SIMPLIFY = FALSE)

```


---
## Plot the results for nice representation

```{r plot.res}
library(ggplot2)
df_all <- do.call(rbind, sumres)

df_hrsd <- df_all %>% filter(outcome == "eff2")

ggplot(df_hrsd, aes(x = method)) +
  geom_linerange(aes(ymin = ci_lb, ymax = ci_ub), linewidth = 1.5) +
  geom_point(aes(y = estimate), color = "black", size = 3) +
  geom_hline(yintercept = -6.0604, linetype = "dashed", color = "#A4031F") +
  coord_flip() +
  labs(
    title = "Uncertainty Intervals for HRSD",
    x = "Imputation Distribution", y = "Treatment Effect (HRSD)"
  ) +
  theme_minimal()

df_bdi <- df_all %>% filter(outcome == "eff1")

ggplot(df_bdi, aes(x = method)) +
  geom_linerange(aes(ymin = ci_lb, ymax = ci_ub), linewidth = 1.5) +
  geom_point(aes(y = estimate), color = "black", size = 3) +
  geom_hline(yintercept = -6.4751, linetype = "dashed", color = "#A4031F") +
  coord_flip() +
  labs(
    title = "Uncertainty Intervals for BDI",
    x = "Imputation Distribution", y = "Treatment Effect (BDI)"
  ) +
  theme_minimal()

```
